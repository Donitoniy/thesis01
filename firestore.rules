rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 作业集合规则
    match /homework/{homeworkId} {
      // 允许已认证用户读取自己的作业
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.studentId;
      
      // 允许已认证用户创建作业（必须是自己的）
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.studentId &&
        validateHomeworkData(request.resource.data);
      
      // 允许学生更新自己的作业
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.studentId &&
        validateHomeworkData(request.resource.data);
      
      // 不允许删除作业（保护数据）
      allow delete: if false;
    }
    
    // 用户个人资料集合
    match /users/{userId} {
      // 用户只能读写自己的资料
      allow read, write: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // 学习进度集合
    match /progress/{userId} {
      // 用户只能读写自己的学习进度
      allow read, write: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // 课程内容（只读）
    match /courses/{courseId} {
      // 已认证用户可以读取课程内容
      allow read: if request.auth != null;
      // 只有管理员可以写入（这里暂时禁止所有写入）
      allow write: if false;
    }
    
    // AI工具体验记录
    match /ai_experiences/{experienceId} {
      // 允许已认证用户读取自己的体验记录
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // 允许已认证用户创建自己的体验记录
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
  }
}

// 验证作业数据的函数
function validateHomeworkData(data) {
  return data.keys().hasAll(['fileName', 'fileSize', 'submitTime', 'studentId', 'studentName', 'status']) &&
         data.fileName is string &&
         data.fileSize is number &&
         data.submitTime is timestamp &&
         data.studentId is string &&
         data.studentName is string &&
         data.status in ['submitted', 'reviewed', 'graded'];
}